<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Simon Grimm">
<meta name="dcterms.date" content="2024-02-23">

<title>Simon’s Public NAO Notebook - Pooled swab sampling for pathogen early detection</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Simon’s Public NAO Notebook</span>
    </a>
  </div>
        <div class="quarto-navbar-tools">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Pooled swab sampling for pathogen early detection</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Simon Grimm </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 23, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<div id="3c601e80" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="3c601e80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="3c601e80-1"><a href="#3c601e80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Importing packages</span></span>
<span id="3c601e80-2"><a href="#3c601e80-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="3c601e80-3"><a href="#3c601e80-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="3c601e80-4"><a href="#3c601e80-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="3c601e80-5"><a href="#3c601e80-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="3c601e80-6"><a href="#3c601e80-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="3c601e80-7"><a href="#3c601e80-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="3c601e80-8"><a href="#3c601e80-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>The NAO aims to detect stealth pathogens at an early stage. Up until, we have have focused much our research on wastewater treatment plant (WTP) samples. While WTP sampling offers some advantages, its limitations include environmental noise, non-human biological material, and low pathogen abundance. The NAO thus also wants to investigate other sampling approaches. To this end we’ve previously researched the promise of air sampling for pathogen early detection, and Will recently created a framework that allows analysis of various types of sampling strategies.</p>
<p>One promising approach is sampling using nasal, nasopharyngeal (NP), or oropharyngeal (OP) swabs. When pooled, these samples have several advantages</p>
<ul>
<li>400x higher RA(1%) than wastewater, atleast based on an initial BOTEC, that I have low confidence in.</li>
<li>More metadata on individuals that contributed to the sample (because you can have them provide some basic metadata when providing the sample.</li>
<li>Potentially less static complexity than wastewater.</li>
<li>If pools are large enough, dynamic complexity could also be lower.</li>
<li>There is more existing research on swab sampling than on other sample types.</li>
</ul>
<p>Still, the approach also has downsides:</p>
<ul>
<li>If not sampling at an airport, getting wide geographic coverage is harder.</li>
<li>Scaling is more expensive than with wastewater, especially increasing the number of samples provided at at given location.</li>
<li>Regulatory hurdles are likely higher than when sampling wastewater.</li>
</ul>
</section>
<section id="pathogen-abundance-and-detection-capability" class="level1">
<h1>Pathogen abundance and detection capability</h1>
<section id="pathogen-shedding" class="level2">
<h2 class="anchored" data-anchor-id="pathogen-shedding">Pathogen shedding</h2>
<p>Among many types of pathogens, respiratory pathogens are particularly likely to cause future pandemics (Amesh A. Adalja, MD, Matthew Watson, …). Though different pathogens have different tropism across tissues (SARS-CoV-2 having a wider wider tropism than influenza (Flerlage et al.&nbsp;2021)), all of them are respiratory pathogens and thus shed in the respiratory tract, which includes the pharynx, mouth, and nose.</p>
<p>In a swab sampling program we could use different swabs that target any of these sitesm, i.e., the nostrils, the nasopharynx, oropharynx, and the mid-turbinate region<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. These sites differ in their comfort of sampling and (probably) in their sensitivity. For instance, nasopharyngeal swabs (NP swabs) would have be far better than other swabs for us to consider them for a sampling program, given that they do not allow self-sampling.</p>
<p>We will evaluate the performance of different swab types in three ways:</p>
<ul>
<li><strong>Sensitivity</strong>: Is the pathogen present at all?</li>
<li><strong>Viral load</strong>: How much of the pathogen can be measured? This metric is based on the qPCR cycle threshold of quantiative.</li>
<li><strong>Relative abundance</strong>: When performing untargeted sequencing, what is the relative abundance of a pathogen?</li>
</ul>
<section id="sensitivity-of-different-swab-types" class="level3">
<h3 class="anchored" data-anchor-id="sensitivity-of-different-swab-types">Sensitivity of different swab types</h3>
<p>(Tsang et al.&nbsp;2021) performed a meta-analysis to evaluate the ability of different swab types in detecting SARS-CoV-2 using qPCR. Swab types included nasal swabs (n=1622), throat swabs (n=388), and pooled nasal and throat swabs (n=719), each of which were compared to nasopharyngeal swabs. Overall, pooled nasal/throat swabs have the best diagnostic performance with sensitivity of 0.97 (0.93-1.00).</p>
<table class="table">
<caption><strong>Table 1: Comparison of different swab sample types.</strong> Adapted from (Tsang et al.&nbsp;2021). Values are effect sizes under a random effects-model. The gold standard is nasopharyngeal swabs.</caption>
<colgroup>
<col style="width: 25%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 23%">
<col style="width: 23%">
</colgroup>
<thead>
<tr class="header">
<th>Sample Type</th>
<th>Sensitivity</th>
<th>Specificity</th>
<th>Positive Predictive Value</th>
<th>Negative Predictive Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Nasal swabs (n=1622)</td>
<td>0.86 (0.77-0.93)</td>
<td>0.99 (0.96-1.00)</td>
<td>0.96 (0.87-1.00)</td>
<td>0.95 (0.88-0.99)</td>
</tr>
<tr class="even">
<td>Throat swabs (n=388)</td>
<td>0.68 (0-35-0.94)</td>
<td>0.97 (0.95-0.99)</td>
<td>0.75 (0.45-0.96)</td>
<td>0.96 (0.94-0.98)</td>
</tr>
<tr class="odd">
<td>Pooled nasal/throat swabs (n=719)</td>
<td>0.97 (0.93-1.00)</td>
<td>0.99 (0.98-1.00)</td>
<td>0.97 (0.90-1.00)</td>
<td>0.99 (0.98-1.00)</td>
</tr>
</tbody>
</table>
<p>Note, though Tsang et al.&nbsp;2021 reports specificity, this metric isn’t very useful in this context. All studies covered by the review used qPCR to detect SARS-CoV-2. qPCR is generally considered to be very sensitive and specific. Thus, if a patient tests positive in a throat swab qPCR, but negative in nasopharyngeal swab qPCR, this shouldn’t be counted against throat swabs (false positive), but rather against nasopharyngeal swabs.</p>
<p>The review above gives us binary information about SARS-CoV-2 being present in different swab types. But we are not merely interested in a pathogen being present in a sample, but how abundant said pathogen is. For instance, hroat swabs coming back negative when NP swabs come back positive tells us that pathogen abundance is likely higher in the nasopharynx, but it’s unclear by how much.</p>
<p>Getting a better understanding of this is particularly relevant when pooling samples because higher relative abundance in an individual positive sample will ensure detection even if said sample is pooled with a large number of negative samples. To quantify this difference in absolute pathogen abundance between sample types we can look beyond positive/negative comparisons and instead look at the differences in CT scores within studies that compared swab types.</p>
</section>
<section id="viral-load-in-different-swab-types" class="level3">
<h3 class="anchored" data-anchor-id="viral-load-in-different-swab-types">Viral load in different swab types</h3>
<section id="nasopharyngeal-swabs" class="level4">
<h4 class="anchored" data-anchor-id="nasopharyngeal-swabs">Nasopharyngeal swabs</h4>
<p>Most studies on swab sampling performance treat nasopharyngeal swabs (NP swabs) as the gold standard, against which, nasal (Kojima et al.&nbsp;2021; Tu et al.&nbsp;2020), mid-turbinate (Tu et al.&nbsp;2020; Muller et al.&nbsp;2021), and combined nasal/oropharyngeal (Desmet et al.&nbsp;2021) swabs are compared. NP swabs are commonly administered by a healthcare professional and a properly administered test absorbs material from below the inferior turbinate, and the nasopharynx located at the back of the nasal cavity.</p>
<p>The CT value difference for paired NP/{Other} swabs are plotted in Figure 1. The CT value of the comparison swab is subtracted from the NP swab CT value. A lower CT is better, thus, a negative cycle threshold (CT) difference equates to a higher pathogen concentration in the NP swab.</p>
<div id="6fa9ba88" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="6fa9ba88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="6fa9ba88-1"><a href="#6fa9ba88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># All CT difference data were calculated in and are taken from https://docs.google.com/spreadsheets/d/1YP4mxT_vxiFwXU5ZuBM4obq_oscfhe05ODWwHFHEznM/</span></span>
<span id="6fa9ba88-2"><a href="#6fa9ba88-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">"data/np_ct_differences.tsv"</span>, sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>, skiprows<span class="op">=</span><span class="dv">1</span>)</span>
<span id="6fa9ba88-3"><a href="#6fa9ba88-3" aria-hidden="true" tabindex="-1"></a>df.columns <span class="op">=</span> df.columns.<span class="bu">str</span>.replace(<span class="st">", "</span>, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="6fa9ba88-4"><a href="#6fa9ba88-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="6fa9ba88-5"><a href="#6fa9ba88-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.melt(var_name<span class="op">=</span><span class="st">"Study &amp; Comparison"</span>, value_name<span class="op">=</span><span class="st">"CT Difference"</span>)</span>
<span id="6fa9ba88-6"><a href="#6fa9ba88-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="6fa9ba88-7"><a href="#6fa9ba88-7" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="fl">3.5</span>))</span>
<span id="6fa9ba88-8"><a href="#6fa9ba88-8" aria-hidden="true" tabindex="-1"></a>sns.stripplot(</span>
<span id="6fa9ba88-9"><a href="#6fa9ba88-9" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>df,</span>
<span id="6fa9ba88-10"><a href="#6fa9ba88-10" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"Study &amp; Comparison"</span>,</span>
<span id="6fa9ba88-11"><a href="#6fa9ba88-11" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"CT Difference"</span>,</span>
<span id="6fa9ba88-12"><a href="#6fa9ba88-12" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span><span class="st">"Study &amp; Comparison"</span>,</span>
<span id="6fa9ba88-13"><a href="#6fa9ba88-13" aria-hidden="true" tabindex="-1"></a>    jitter<span class="op">=</span><span class="va">True</span>,</span>
<span id="6fa9ba88-14"><a href="#6fa9ba88-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="6fa9ba88-15"><a href="#6fa9ba88-15" aria-hidden="true" tabindex="-1"></a>plt.legend([], [], frameon<span class="op">=</span><span class="va">False</span>)</span>
<span id="6fa9ba88-16"><a href="#6fa9ba88-16" aria-hidden="true" tabindex="-1"></a><span class="co"># drop y axis label</span></span>
<span id="6fa9ba88-17"><a href="#6fa9ba88-17" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">""</span>)</span>
<span id="6fa9ba88-18"><a href="#6fa9ba88-18" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"SARS-CoV-2 qPCR CT Δ (NP - Comparison)"</span>)</span>
<span id="6fa9ba88-19"><a href="#6fa9ba88-19" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">"y"</span>, which<span class="op">=</span><span class="st">"both"</span>, left<span class="op">=</span><span class="va">False</span>, right<span class="op">=</span><span class="va">False</span>, labelleft<span class="op">=</span><span class="va">True</span>)</span>
<span id="6fa9ba88-20"><a href="#6fa9ba88-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> <span class="dv">5</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">5</span>, <span class="op">-</span><span class="dv">10</span>, <span class="op">-</span><span class="dv">15</span>:</span>
<span id="6fa9ba88-21"><a href="#6fa9ba88-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="6fa9ba88-22"><a href="#6fa9ba88-22" aria-hidden="true" tabindex="-1"></a>        plt.axvline(x<span class="op">=</span>x, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="6fa9ba88-23"><a href="#6fa9ba88-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="6fa9ba88-24"><a href="#6fa9ba88-24" aria-hidden="true" tabindex="-1"></a>    plt.axvline(x<span class="op">=</span>x, color<span class="op">=</span><span class="st">"grey"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="6fa9ba88-25"><a href="#6fa9ba88-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="6fa9ba88-26"><a href="#6fa9ba88-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> y <span class="kw">in</span> <span class="fl">0.5</span>, <span class="fl">1.5</span>, <span class="fl">2.5</span>, <span class="fl">3.5</span>, <span class="fl">4.5</span>:</span>
<span id="6fa9ba88-27"><a href="#6fa9ba88-27" aria-hidden="true" tabindex="-1"></a>    plt.axhline(y<span class="op">=</span>y, color<span class="op">=</span><span class="st">"grey"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="6fa9ba88-28"><a href="#6fa9ba88-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="6fa9ba88-29"><a href="#6fa9ba88-29" aria-hidden="true" tabindex="-1"></a>min_x, max_x <span class="op">=</span> plt.xlim()</span>
<span id="6fa9ba88-30"><a href="#6fa9ba88-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="6fa9ba88-31"><a href="#6fa9ba88-31" aria-hidden="true" tabindex="-1"></a>plt.text(max_x <span class="op">/</span> <span class="dv">2</span>, <span class="op">-</span><span class="fl">0.6</span>, <span class="st">"Favors Comparison"</span>, fontsize<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">"black"</span>, ha<span class="op">=</span><span class="st">"center"</span>)</span>
<span id="6fa9ba88-32"><a href="#6fa9ba88-32" aria-hidden="true" tabindex="-1"></a>plt.text(min_x <span class="op">/</span> <span class="dv">2</span>, <span class="op">-</span><span class="fl">0.6</span>, <span class="st">"Favors NP Swab"</span>, fontsize<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">"black"</span>, ha<span class="op">=</span><span class="st">"center"</span>)</span>
<span id="6fa9ba88-33"><a href="#6fa9ba88-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="6fa9ba88-34"><a href="#6fa9ba88-34" aria-hidden="true" tabindex="-1"></a>plt.gca().spines[<span class="st">"right"</span>].set_visible(<span class="va">False</span>)</span>
<span id="6fa9ba88-35"><a href="#6fa9ba88-35" aria-hidden="true" tabindex="-1"></a>plt.gca().spines[<span class="st">"top"</span>].set_visible(<span class="va">False</span>)</span>
<span id="6fa9ba88-36"><a href="#6fa9ba88-36" aria-hidden="true" tabindex="-1"></a>plt.gca().spines[<span class="st">"left"</span>].set_visible(<span class="va">False</span>)</span>
<span id="6fa9ba88-37"><a href="#6fa9ba88-37" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/cell-3-output-1.png" width="820" height="334" class="figure-img"></p>
<figcaption><strong>Figure 1: Nasopharyngeal vs Nasal, Mid-Turbinate, and combined Oropharyngeal/ Nasal swabs.</strong> Data from Kojima et al.&nbsp;2020, Tu et al.&nbsp;2020, Muller et al.&nbsp;2021, and Desmet et al.&nbsp;2021.</figcaption>
</figure>
</div>
</div>
</div>
<p>Apart from self-collected mid-turbinate swabs in Tu et al.&nbsp;2020, NP swabs show equivalent performance to nasal swabs in Kojima et al.&nbsp;2020, mid-turbinate swabs in Muller et al.&nbsp;2021, and combined nasal/throat swabs in Desmet et al 2021; and equivalent performance to nasal swabs in Tu et al.&nbsp;2020. In the same study, nasal swabs prove equivalent to NP swabs. Combined oro-pharyngeal swabs are also equivalent to NP swabs.</p>
<p>Studies that use NP swabs as their gold standard are useful to better understand the performance of other swab types, but NP swabs themselves are not practical for a large-scale pooled sampling programs: NP swabs are notoriously uncomfortable and are commonly administered by a third person. In contrast, nasal or oropharyngeal swabs would be more suitable for self-sampling, which allows far higher testing throughput. Let’s thus look at studies that compare nasal and oropharyngeal swabs.</p>
</section>
</section>
<section id="nasal-swabs" class="level3">
<h3 class="anchored" data-anchor-id="nasal-swabs">Nasal Swabs</h3>
<p>Note that the second plot shows the difference in genome copy numbers, rather than CT values<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p>
<div id="0b90e2d6" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="0b90e2d6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="0b90e2d6-1"><a href="#0b90e2d6-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">"data/nasal_ct_differences.tsv"</span>, sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>, skiprows<span class="op">=</span><span class="dv">1</span>)</span>
<span id="0b90e2d6-2"><a href="#0b90e2d6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="0b90e2d6-3"><a href="#0b90e2d6-3" aria-hidden="true" tabindex="-1"></a>df.columns <span class="op">=</span> df.columns.<span class="bu">str</span>.replace(<span class="st">", "</span>, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="0b90e2d6-4"><a href="#0b90e2d6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># reshape dataframe to long format</span></span>
<span id="0b90e2d6-5"><a href="#0b90e2d6-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.melt(var_name<span class="op">=</span><span class="st">"Study &amp; Comparison"</span>, value_name<span class="op">=</span><span class="st">"CT Difference"</span>)</span>
<span id="0b90e2d6-6"><a href="#0b90e2d6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="0b90e2d6-7"><a href="#0b90e2d6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="0b90e2d6-8"><a href="#0b90e2d6-8" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="fl">1.5</span>))</span>
<span id="0b90e2d6-9"><a href="#0b90e2d6-9" aria-hidden="true" tabindex="-1"></a>sns.stripplot(</span>
<span id="0b90e2d6-10"><a href="#0b90e2d6-10" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>df,</span>
<span id="0b90e2d6-11"><a href="#0b90e2d6-11" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"Study &amp; Comparison"</span>,</span>
<span id="0b90e2d6-12"><a href="#0b90e2d6-12" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"CT Difference"</span>,</span>
<span id="0b90e2d6-13"><a href="#0b90e2d6-13" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span><span class="st">"Study &amp; Comparison"</span>,</span>
<span id="0b90e2d6-14"><a href="#0b90e2d6-14" aria-hidden="true" tabindex="-1"></a>    jitter<span class="op">=</span><span class="va">True</span>,</span>
<span id="0b90e2d6-15"><a href="#0b90e2d6-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="0b90e2d6-16"><a href="#0b90e2d6-16" aria-hidden="true" tabindex="-1"></a>plt.legend([], [], frameon<span class="op">=</span><span class="va">False</span>)</span>
<span id="0b90e2d6-17"><a href="#0b90e2d6-17" aria-hidden="true" tabindex="-1"></a><span class="co"># drop y axis label</span></span>
<span id="0b90e2d6-18"><a href="#0b90e2d6-18" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">""</span>)</span>
<span id="0b90e2d6-19"><a href="#0b90e2d6-19" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"SARS-CoV-2 qPCR CT Δ (Nasal - Comparison)"</span>)</span>
<span id="0b90e2d6-20"><a href="#0b90e2d6-20" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">"y"</span>, which<span class="op">=</span><span class="st">"both"</span>, left<span class="op">=</span><span class="va">False</span>, right<span class="op">=</span><span class="va">False</span>, labelleft<span class="op">=</span><span class="va">True</span>)</span>
<span id="0b90e2d6-21"><a href="#0b90e2d6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="0b90e2d6-22"><a href="#0b90e2d6-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> <span class="dv">5</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">5</span>, <span class="op">-</span><span class="dv">10</span>, <span class="op">-</span><span class="dv">15</span>:</span>
<span id="0b90e2d6-23"><a href="#0b90e2d6-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="0b90e2d6-24"><a href="#0b90e2d6-24" aria-hidden="true" tabindex="-1"></a>        plt.axvline(x<span class="op">=</span>x, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="0b90e2d6-25"><a href="#0b90e2d6-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="0b90e2d6-26"><a href="#0b90e2d6-26" aria-hidden="true" tabindex="-1"></a>        plt.axvline(x<span class="op">=</span>x, color<span class="op">=</span><span class="st">"grey"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="0b90e2d6-27"><a href="#0b90e2d6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="0b90e2d6-28"><a href="#0b90e2d6-28" aria-hidden="true" tabindex="-1"></a>plt.axhline(y<span class="op">=</span><span class="fl">0.5</span>, color<span class="op">=</span><span class="st">"grey"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="0b90e2d6-29"><a href="#0b90e2d6-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="0b90e2d6-30"><a href="#0b90e2d6-30" aria-hidden="true" tabindex="-1"></a>min_x, max_x <span class="op">=</span> plt.xlim()</span>
<span id="0b90e2d6-31"><a href="#0b90e2d6-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="0b90e2d6-32"><a href="#0b90e2d6-32" aria-hidden="true" tabindex="-1"></a>plt.text(max_x <span class="op">/</span> <span class="dv">2</span>, <span class="op">-</span><span class="fl">0.6</span>, <span class="st">"Favors Comparison"</span>, fontsize<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">"black"</span>, ha<span class="op">=</span><span class="st">"center"</span>)</span>
<span id="0b90e2d6-33"><a href="#0b90e2d6-33" aria-hidden="true" tabindex="-1"></a>plt.text(min_x <span class="op">/</span> <span class="dv">2</span>, <span class="op">-</span><span class="fl">0.6</span>, <span class="st">"Favors Nasal Swab"</span>, fontsize<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">"black"</span>, ha<span class="op">=</span><span class="st">"center"</span>)</span>
<span id="0b90e2d6-34"><a href="#0b90e2d6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="0b90e2d6-35"><a href="#0b90e2d6-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="0b90e2d6-36"><a href="#0b90e2d6-36" aria-hidden="true" tabindex="-1"></a>plt.gca().spines[<span class="st">"right"</span>].set_visible(<span class="va">False</span>)</span>
<span id="0b90e2d6-37"><a href="#0b90e2d6-37" aria-hidden="true" tabindex="-1"></a>plt.gca().spines[<span class="st">"top"</span>].set_visible(<span class="va">False</span>)</span>
<span id="0b90e2d6-38"><a href="#0b90e2d6-38" aria-hidden="true" tabindex="-1"></a>plt.gca().spines[<span class="st">"left"</span>].set_visible(<span class="va">False</span>)</span>
<span id="0b90e2d6-39"><a href="#0b90e2d6-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="0b90e2d6-40"><a href="#0b90e2d6-40" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/cell-4-output-1.png" width="820" height="186" class="figure-img"></p>
<figcaption><strong>Figure 2: Nasal swabs vs Oro-pharyngeal and combined nasal/oro-pharyngeal swabs.</strong> All data is taken from Goodall et al.&nbsp;2022.</figcaption>
</figure>
</div>
</div>
</div>
<div id="d847d2bd" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="d847d2bd"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="d847d2bd-1"><a href="#d847d2bd-1" aria-hidden="true" tabindex="-1"></a><span class="co"># All CT difference data was calculated and is taken from https://docs.google.com/spreadsheets/d/1YP4mxT_vxiFwXU5ZuBM4obq_oscfhe05ODWwHFHEznM/</span></span>
<span id="d847d2bd-2"><a href="#d847d2bd-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="d847d2bd-3"><a href="#d847d2bd-3" aria-hidden="true" tabindex="-1"></a><span class="co"># turn tsv into dataframe. Ignore first row. Second row is column names.</span></span>
<span id="d847d2bd-4"><a href="#d847d2bd-4" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">"data/leung_genome_copy_differences.tsv"</span>, sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>, skiprows<span class="op">=</span><span class="dv">1</span>)</span>
<span id="d847d2bd-5"><a href="#d847d2bd-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="d847d2bd-6"><a href="#d847d2bd-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="d847d2bd-7"><a href="#d847d2bd-7" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.melt(var_name<span class="op">=</span><span class="st">"Study &amp; Comparison"</span>, value_name<span class="op">=</span><span class="st">"Genome Copy Number Difference"</span>)</span>
<span id="d847d2bd-8"><a href="#d847d2bd-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="d847d2bd-9"><a href="#d847d2bd-9" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"Study &amp; Comparison"</span>] <span class="op">=</span> df[<span class="st">"Study &amp; Comparison"</span>].<span class="bu">str</span>.split(<span class="st">","</span>).<span class="bu">str</span>[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="d847d2bd-10"><a href="#d847d2bd-10" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">2</span>))</span>
<span id="d847d2bd-11"><a href="#d847d2bd-11" aria-hidden="true" tabindex="-1"></a>sns.stripplot(</span>
<span id="d847d2bd-12"><a href="#d847d2bd-12" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>df,</span>
<span id="d847d2bd-13"><a href="#d847d2bd-13" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"Study &amp; Comparison"</span>,</span>
<span id="d847d2bd-14"><a href="#d847d2bd-14" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"Genome Copy Number Difference"</span>,</span>
<span id="d847d2bd-15"><a href="#d847d2bd-15" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span><span class="st">"Study &amp; Comparison"</span>,</span>
<span id="d847d2bd-16"><a href="#d847d2bd-16" aria-hidden="true" tabindex="-1"></a>    jitter<span class="op">=</span><span class="va">True</span>,</span>
<span id="d847d2bd-17"><a href="#d847d2bd-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="d847d2bd-18"><a href="#d847d2bd-18" aria-hidden="true" tabindex="-1"></a>plt.legend([], [], frameon<span class="op">=</span><span class="va">False</span>)</span>
<span id="d847d2bd-19"><a href="#d847d2bd-19" aria-hidden="true" tabindex="-1"></a><span class="co"># drop y axis label</span></span>
<span id="d847d2bd-20"><a href="#d847d2bd-20" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">""</span>)</span>
<span id="d847d2bd-21"><a href="#d847d2bd-21" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Genome Copy Number Δ (Nasal - Throat), Logged"</span>)</span>
<span id="d847d2bd-22"><a href="#d847d2bd-22" aria-hidden="true" tabindex="-1"></a><span class="co"># flip x axis</span></span>
<span id="d847d2bd-23"><a href="#d847d2bd-23" aria-hidden="true" tabindex="-1"></a>plt.gca().invert_xaxis()</span>
<span id="d847d2bd-24"><a href="#d847d2bd-24" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">"y"</span>, which<span class="op">=</span><span class="st">"both"</span>, left<span class="op">=</span><span class="va">False</span>, right<span class="op">=</span><span class="va">False</span>, labelleft<span class="op">=</span><span class="va">True</span>)</span>
<span id="d847d2bd-25"><a href="#d847d2bd-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> <span class="op">-</span><span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>:</span>
<span id="d847d2bd-26"><a href="#d847d2bd-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="d847d2bd-27"><a href="#d847d2bd-27" aria-hidden="true" tabindex="-1"></a>        plt.axvline(x<span class="op">=</span>x, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="d847d2bd-28"><a href="#d847d2bd-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="d847d2bd-29"><a href="#d847d2bd-29" aria-hidden="true" tabindex="-1"></a>    plt.axvline(x<span class="op">=</span>x, color<span class="op">=</span><span class="st">"grey"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="d847d2bd-30"><a href="#d847d2bd-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="d847d2bd-31"><a href="#d847d2bd-31" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> y <span class="kw">in</span> <span class="fl">0.5</span>, <span class="fl">1.5</span>:</span>
<span id="d847d2bd-32"><a href="#d847d2bd-32" aria-hidden="true" tabindex="-1"></a>    plt.axhline(y<span class="op">=</span>y, color<span class="op">=</span><span class="st">"grey"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="d847d2bd-33"><a href="#d847d2bd-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="d847d2bd-34"><a href="#d847d2bd-34" aria-hidden="true" tabindex="-1"></a>min_x, max_x <span class="op">=</span> plt.xlim()</span>
<span id="d847d2bd-35"><a href="#d847d2bd-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="d847d2bd-36"><a href="#d847d2bd-36" aria-hidden="true" tabindex="-1"></a>plt.text(max_x <span class="op">/</span> <span class="dv">2</span>, <span class="op">-</span><span class="fl">0.6</span>, <span class="st">"Favors Throat Swab"</span>, fontsize<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">"black"</span>, ha<span class="op">=</span><span class="st">"center"</span>)</span>
<span id="d847d2bd-37"><a href="#d847d2bd-37" aria-hidden="true" tabindex="-1"></a>plt.text(min_x <span class="op">/</span> <span class="dv">2</span>, <span class="op">-</span><span class="fl">0.6</span>, <span class="st">"Favors Nasal Swab"</span>, fontsize<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">"black"</span>, ha<span class="op">=</span><span class="st">"center"</span>)</span>
<span id="d847d2bd-38"><a href="#d847d2bd-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="d847d2bd-39"><a href="#d847d2bd-39" aria-hidden="true" tabindex="-1"></a>plt.gca().spines[<span class="st">"right"</span>].set_visible(<span class="va">False</span>)</span>
<span id="d847d2bd-40"><a href="#d847d2bd-40" aria-hidden="true" tabindex="-1"></a>plt.gca().spines[<span class="st">"top"</span>].set_visible(<span class="va">False</span>)</span>
<span id="d847d2bd-41"><a href="#d847d2bd-41" aria-hidden="true" tabindex="-1"></a>plt.gca().spines[<span class="st">"left"</span>].set_visible(<span class="va">False</span>)</span>
<span id="d847d2bd-42"><a href="#d847d2bd-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="d847d2bd-43"><a href="#d847d2bd-43" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/cell-5-output-1.png" width="760" height="223" class="figure-img"></p>
<figcaption><strong>Figure 3: Nasal swabs vs Oro-pharyngeal swabs.</strong> All data is taken from Leung et al.&nbsp;2020.</figcaption>
</figure>
</div>
</div>
</div>
<p>In qPCR measurements, nasal swabs contain more virus copies than throat swabs. In (Goodall et al.&nbsp;2022), nasal swabs are slightly superior to throat swabs and combined/nasal throat swabs, and come out about even when compared to combined nasal/OP swabs. In (Leung et al.&nbsp;2020), researchers ran multiplex-PCR on both nasal and throat swamples. qPCR differences are plotted in Figure 3 for Human Coronavirus, Influenza, and Rhinovirus.</p>
</section>
</section>
</section>
<section id="virus-relative-abundance-across-different-swab-types" class="level1">
<h1>Virus relative abundance across different swab types</h1>
<p>Whatever the sample type, ultimately we will want to perform metagenomic sequencing to detect novel pathogens. As described in a <a href="https://naobservatory.org/reports/comparing-sampling-strategies-for-early-detection-of-stealth-biothreats/">previous report</a>, the value of a metagenomic sequencing sample will can be assessed across several dimensions:</p>
<ul>
<li>What is the expected relative abundance of a human-infecting stealth virus?</li>
<li>How complex are individual sequencing samples? I.e, what is their species richness and evenness?</li>
<li>How much does the background complexity of a sample vary between individuals and over time?</li>
</ul>
<p>The relative abundance of a target pathogen can be impacted by its microbial background, because the sequencing efficiency of a taxon is directly dependant on the sampling efficiency of the other taxa in the sample<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<p>We identified two studies that performed paired metagenomic sequencing and SARS-CoV-2 qPCR on swab samples Lu et al.&nbsp;2021, Babiker et al.&nbsp;2020. We’ve reached out to the authors of two further studies that didn’t have publicly available data.</p>
<div id="62571bd2" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="62571bd2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="62571bd2-1"><a href="#62571bd2-1" aria-hidden="true" tabindex="-1"></a>df_throat <span class="op">=</span> pd.read_csv(<span class="st">"data/lu_throat_ct_mgs.tsv"</span>, sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>, skiprows<span class="op">=</span><span class="dv">1</span>)</span>
<span id="62571bd2-2"><a href="#62571bd2-2" aria-hidden="true" tabindex="-1"></a>df_throat.rename(</span>
<span id="62571bd2-3"><a href="#62571bd2-3" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>{<span class="st">"SCV-2 Relative Abundance"</span>: <span class="st">"scv2_ra"</span>, <span class="st">"Ct value"</span>: <span class="st">"scv2_ct"</span>}, inplace<span class="op">=</span><span class="va">True</span></span>
<span id="62571bd2-4"><a href="#62571bd2-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="62571bd2-5"><a href="#62571bd2-5" aria-hidden="true" tabindex="-1"></a>df_nasopharyngeal <span class="op">=</span> pd.read_csv(<span class="st">"data/babiker_np_ct_mgs.tsv"</span>, sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>, skiprows<span class="op">=</span><span class="dv">1</span>)</span>
<span id="62571bd2-6"><a href="#62571bd2-6" aria-hidden="true" tabindex="-1"></a>df_nasopharyngeal.rename(</span>
<span id="62571bd2-7"><a href="#62571bd2-7" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>{</span>
<span id="62571bd2-8"><a href="#62571bd2-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"SARS-CoV-2 RT-PCR Ct"</span>: <span class="st">"scv2_ct"</span>,</span>
<span id="62571bd2-9"><a href="#62571bd2-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"SARS-CoV-2 RA"</span>: <span class="st">"scv2_ra"</span>,</span>
<span id="62571bd2-10"><a href="#62571bd2-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Inpatient/ED vs. Outpatient"</span>: <span class="st">"patient_status"</span>,</span>
<span id="62571bd2-11"><a href="#62571bd2-11" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="62571bd2-12"><a href="#62571bd2-12" aria-hidden="true" tabindex="-1"></a>    inplace<span class="op">=</span><span class="va">True</span>,</span>
<span id="62571bd2-13"><a href="#62571bd2-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="62571bd2-14"><a href="#62571bd2-14" aria-hidden="true" tabindex="-1"></a>df_nasopharyngeal[<span class="st">"scv2_ct"</span>] <span class="op">=</span> (</span>
<span id="62571bd2-15"><a href="#62571bd2-15" aria-hidden="true" tabindex="-1"></a>    df_nasopharyngeal[<span class="st">"scv2_ct"</span>].replace(<span class="st">","</span>, <span class="st">"."</span>, regex<span class="op">=</span><span class="va">True</span>).astype(<span class="bu">float</span>)</span>
<span id="62571bd2-16"><a href="#62571bd2-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="62571bd2-17"><a href="#62571bd2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="62571bd2-18"><a href="#62571bd2-18" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">6</span>))</span>
<span id="62571bd2-19"><a href="#62571bd2-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (ax, df) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(axs, [df_throat, df_nasopharyngeal])):</span>
<span id="62571bd2-20"><a href="#62571bd2-20" aria-hidden="true" tabindex="-1"></a>    sns_default_colors <span class="op">=</span> sns.color_palette()</span>
<span id="62571bd2-21"><a href="#62571bd2-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pick 4th and 10th color from palette</span></span>
<span id="62571bd2-22"><a href="#62571bd2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="62571bd2-23"><a href="#62571bd2-23" aria-hidden="true" tabindex="-1"></a>    x_lim <span class="op">=</span> <span class="fl">12.5</span>, <span class="dv">40</span></span>
<span id="62571bd2-24"><a href="#62571bd2-24" aria-hidden="true" tabindex="-1"></a>    y_lim <span class="op">=</span> <span class="dv">10</span><span class="op">**-</span><span class="dv">8</span>, <span class="dv">10</span><span class="op">**</span><span class="dv">0</span></span>
<span id="62571bd2-25"><a href="#62571bd2-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> i <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="62571bd2-26"><a href="#62571bd2-26" aria-hidden="true" tabindex="-1"></a>        sns.scatterplot(</span>
<span id="62571bd2-27"><a href="#62571bd2-27" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax,</span>
<span id="62571bd2-28"><a href="#62571bd2-28" aria-hidden="true" tabindex="-1"></a>            data<span class="op">=</span>df,</span>
<span id="62571bd2-29"><a href="#62571bd2-29" aria-hidden="true" tabindex="-1"></a>            x<span class="op">=</span><span class="st">"scv2_ct"</span>,</span>
<span id="62571bd2-30"><a href="#62571bd2-30" aria-hidden="true" tabindex="-1"></a>            y<span class="op">=</span><span class="st">"scv2_ra"</span>,</span>
<span id="62571bd2-31"><a href="#62571bd2-31" aria-hidden="true" tabindex="-1"></a>            hue<span class="op">=</span><span class="st">"patient_status"</span>,</span>
<span id="62571bd2-32"><a href="#62571bd2-32" aria-hidden="true" tabindex="-1"></a>            style<span class="op">=</span><span class="st">"patient_status"</span>,</span>
<span id="62571bd2-33"><a href="#62571bd2-33" aria-hidden="true" tabindex="-1"></a>            palette<span class="op">=</span>sns_default_colors,</span>
<span id="62571bd2-34"><a href="#62571bd2-34" aria-hidden="true" tabindex="-1"></a>            s<span class="op">=</span><span class="dv">70</span>,</span>
<span id="62571bd2-35"><a href="#62571bd2-35" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="62571bd2-36"><a href="#62571bd2-36" aria-hidden="true" tabindex="-1"></a>        ax.legend(title<span class="op">=</span><span class="st">""</span>, loc<span class="op">=</span><span class="st">"upper left"</span>)</span>
<span id="62571bd2-37"><a href="#62571bd2-37" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">"SARS-CoV-2 qPCR CT Value"</span>)</span>
<span id="62571bd2-38"><a href="#62571bd2-38" aria-hidden="true" tabindex="-1"></a>        ax.set_xlim(x_lim)</span>
<span id="62571bd2-39"><a href="#62571bd2-39" aria-hidden="true" tabindex="-1"></a>        ax.set_ylim(<span class="dv">10</span><span class="op">**-</span><span class="dv">8</span>, <span class="dv">10</span><span class="op">**</span><span class="dv">0</span>)</span>
<span id="62571bd2-40"><a href="#62571bd2-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="62571bd2-41"><a href="#62571bd2-41" aria-hidden="true" tabindex="-1"></a>        sns.scatterplot(</span>
<span id="62571bd2-42"><a href="#62571bd2-42" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax, data<span class="op">=</span>df, x<span class="op">=</span><span class="st">"scv2_ct"</span>, y<span class="op">=</span><span class="st">"scv2_ra"</span>, color<span class="op">=</span>sns_default_colors[<span class="dv">3</span>], s<span class="op">=</span><span class="dv">70</span></span>
<span id="62571bd2-43"><a href="#62571bd2-43" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="62571bd2-44"><a href="#62571bd2-44" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">""</span>)</span>
<span id="62571bd2-45"><a href="#62571bd2-45" aria-hidden="true" tabindex="-1"></a>        ax.set_xlim(x_lim)</span>
<span id="62571bd2-46"><a href="#62571bd2-46" aria-hidden="true" tabindex="-1"></a>        ax.set_ylim(y_lim)</span>
<span id="62571bd2-47"><a href="#62571bd2-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="62571bd2-48"><a href="#62571bd2-48" aria-hidden="true" tabindex="-1"></a>    ax.set_yscale(<span class="st">"log"</span>)</span>
<span id="62571bd2-49"><a href="#62571bd2-49" aria-hidden="true" tabindex="-1"></a>    ax.invert_xaxis()</span>
<span id="62571bd2-50"><a href="#62571bd2-50" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"right"</span>].set_visible(<span class="va">False</span>)</span>
<span id="62571bd2-51"><a href="#62571bd2-51" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"top"</span>].set_visible(<span class="va">False</span>)</span>
<span id="62571bd2-52"><a href="#62571bd2-52" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">"y"</span>, which<span class="op">=</span><span class="st">"both"</span>, left<span class="op">=</span><span class="va">False</span>, right<span class="op">=</span><span class="va">False</span>, labelleft<span class="op">=</span><span class="va">True</span>)</span>
<span id="62571bd2-53"><a href="#62571bd2-53" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">"Relative Abundance"</span>)</span>
<span id="62571bd2-54"><a href="#62571bd2-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> x <span class="kw">in</span> np.arange(<span class="dv">15</span>, <span class="dv">40</span>, <span class="dv">5</span>):</span>
<span id="62571bd2-55"><a href="#62571bd2-55" aria-hidden="true" tabindex="-1"></a>        ax.axvline(x<span class="op">=</span>x, color<span class="op">=</span><span class="st">"grey"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="62571bd2-56"><a href="#62571bd2-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> y <span class="kw">in</span> <span class="bu">range</span>(<span class="op">-</span><span class="dv">7</span>, <span class="dv">1</span>, <span class="dv">1</span>):</span>
<span id="62571bd2-57"><a href="#62571bd2-57" aria-hidden="true" tabindex="-1"></a>        log_y <span class="op">=</span> <span class="dv">10</span><span class="op">**</span>y</span>
<span id="62571bd2-58"><a href="#62571bd2-58" aria-hidden="true" tabindex="-1"></a>        ax.axhline(y<span class="op">=</span>log_y, color<span class="op">=</span><span class="st">"grey"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/cell-6-output-1.png" width="748" height="509" class="figure-img"></p>
<figcaption><strong>Figure 4: SARS-CoV-2 qPCR CT vs SARS-CoV-2 RA.</strong> Top Figure: Throat Swabs. Data from Lu et al.&nbsp;2021. Bottom Figure: Nasopharyngeal Swabs. Data from Babiker et al.&nbsp;2020.</figcaption>
</figure>
</div>
</div>
</div>
<p>Some observations:</p>
<ul>
<li>Though comparing qPCR values between studies is tricky, we do see the expected difference in CT values, where nasopharyngeal swabs have lower CT values.</li>
<li>For the same CT value, Lu et al.&nbsp;2021 returns higher relative abundance.</li>
<li>Outpatients in Lu et al.&nbsp;have slightly higher relative abundances for the same CT value.</li>
</ul>
<section id="influenza-a" class="level3">
<h3 class="anchored" data-anchor-id="influenza-a">Influenza A</h3>
<div id="e3670fba" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="e3670fba"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="e3670fba-1"><a href="#e3670fba-1" aria-hidden="true" tabindex="-1"></a>df_influenza <span class="op">=</span> pd.read_csv(<span class="st">"data/fischer_influenza_ct_mgs.tsv"</span>, sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>, skiprows<span class="op">=</span><span class="dv">1</span>)</span>
<span id="e3670fba-2"><a href="#e3670fba-2" aria-hidden="true" tabindex="-1"></a>df_influenza.rename(</span>
<span id="e3670fba-3"><a href="#e3670fba-3" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>{<span class="st">"FluA CT"</span>: <span class="st">"flua_ct"</span>, <span class="st">"Relative Abundance"</span>: <span class="st">"flua_mgs"</span>}, inplace<span class="op">=</span><span class="va">True</span></span>
<span id="e3670fba-4"><a href="#e3670fba-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="e3670fba-5"><a href="#e3670fba-5" aria-hidden="true" tabindex="-1"></a><span class="co"># drop rows where flua_ct is a string</span></span>
<span id="e3670fba-6"><a href="#e3670fba-6" aria-hidden="true" tabindex="-1"></a><span class="co"># print(df_influenza['flua_ct'].unique())</span></span>
<span id="e3670fba-7"><a href="#e3670fba-7" aria-hidden="true" tabindex="-1"></a>df_influenza[<span class="st">"flua_ct"</span>] <span class="op">=</span> df_influenza[df_influenza[<span class="st">"flua_ct"</span>] <span class="op">!=</span> <span class="st">"Neg"</span>][</span>
<span id="e3670fba-8"><a href="#e3670fba-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"flua_ct"</span></span>
<span id="e3670fba-9"><a href="#e3670fba-9" aria-hidden="true" tabindex="-1"></a>].astype(<span class="bu">int</span>)</span>
<span id="e3670fba-10"><a href="#e3670fba-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="e3670fba-11"><a href="#e3670fba-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="e3670fba-12"><a href="#e3670fba-12" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">3</span>))</span>
<span id="e3670fba-13"><a href="#e3670fba-13" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="fl">12.5</span>, <span class="dv">40</span>)</span>
<span id="e3670fba-14"><a href="#e3670fba-14" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">10</span><span class="op">**-</span><span class="dv">8</span>, <span class="dv">10</span><span class="op">**</span><span class="dv">0</span>)</span>
<span id="e3670fba-15"><a href="#e3670fba-15" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(</span>
<span id="e3670fba-16"><a href="#e3670fba-16" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>df_influenza,</span>
<span id="e3670fba-17"><a href="#e3670fba-17" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"flua_ct"</span>,</span>
<span id="e3670fba-18"><a href="#e3670fba-18" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"flua_mgs"</span>,</span>
<span id="e3670fba-19"><a href="#e3670fba-19" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span><span class="st">"Sample Type"</span>,</span>
<span id="e3670fba-20"><a href="#e3670fba-20" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span>sns_default_colors,</span>
<span id="e3670fba-21"><a href="#e3670fba-21" aria-hidden="true" tabindex="-1"></a>    s<span class="op">=</span><span class="dv">70</span>,</span>
<span id="e3670fba-22"><a href="#e3670fba-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="e3670fba-23"><a href="#e3670fba-23" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Influenza A qPCR CT Value"</span>)</span>
<span id="e3670fba-24"><a href="#e3670fba-24" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Relative Abundance"</span>)</span>
<span id="e3670fba-25"><a href="#e3670fba-25" aria-hidden="true" tabindex="-1"></a>ax.set_yscale(<span class="st">"log"</span>)</span>
<span id="e3670fba-26"><a href="#e3670fba-26" aria-hidden="true" tabindex="-1"></a>ax.invert_xaxis()</span>
<span id="e3670fba-27"><a href="#e3670fba-27" aria-hidden="true" tabindex="-1"></a>ax.spines[<span class="st">"right"</span>].set_visible(<span class="va">False</span>)</span>
<span id="e3670fba-28"><a href="#e3670fba-28" aria-hidden="true" tabindex="-1"></a>ax.spines[<span class="st">"top"</span>].set_visible(<span class="va">False</span>)</span>
<span id="e3670fba-29"><a href="#e3670fba-29" aria-hidden="true" tabindex="-1"></a>ax.tick_params(axis<span class="op">=</span><span class="st">"y"</span>, which<span class="op">=</span><span class="st">"both"</span>, left<span class="op">=</span><span class="va">False</span>, right<span class="op">=</span><span class="va">False</span>, labelleft<span class="op">=</span><span class="va">True</span>)</span>
<span id="e3670fba-30"><a href="#e3670fba-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> np.arange(<span class="dv">15</span>, <span class="dv">40</span>, <span class="dv">5</span>):</span>
<span id="e3670fba-31"><a href="#e3670fba-31" aria-hidden="true" tabindex="-1"></a>    ax.axvline(x<span class="op">=</span>x, color<span class="op">=</span><span class="st">"grey"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="e3670fba-32"><a href="#e3670fba-32" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> y <span class="kw">in</span> <span class="bu">range</span>(<span class="op">-</span><span class="dv">7</span>, <span class="dv">1</span>, <span class="dv">1</span>):</span>
<span id="e3670fba-33"><a href="#e3670fba-33" aria-hidden="true" tabindex="-1"></a>    log_y <span class="op">=</span> <span class="dv">10</span><span class="op">**</span>y</span>
<span id="e3670fba-34"><a href="#e3670fba-34" aria-hidden="true" tabindex="-1"></a>    ax.axhline(y<span class="op">=</span>log_y, color<span class="op">=</span><span class="st">"grey"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-7-output-1.png" width="748" height="287" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="simulating-detection-capability" class="level1">
<h1>Simulating detection capability</h1>
<p>We can use the above data to replicate research by Jeff Kaufman. Let’s say we get a random set of swabs from a population which contains 1% sick people. On average 1% of all swabs will return positive, and the relative abundance in that positive sample is picked randomly among the relative abundances given in Lu et al.&nbsp;2021 and Babiker et al.&nbsp;2020, respectively.</p>
<p>Based on this, the median RA(1%) in a pooled sample with 200 swabs is ~ 10^-4.8 Lu et al.&nbsp;2021 (throat swabs) and 10^-5.9 in Babiker et al.&nbsp;2020 (NP swabs)</p>
<div id="c072fb7d" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="c072fb7d"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="c072fb7d-1"><a href="#c072fb7d-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> simulate_detection(positive_ras):</span>
<span id="c072fb7d-2"><a href="#c072fb7d-2" aria-hidden="true" tabindex="-1"></a>    FRAC_SICK <span class="op">=</span> <span class="fl">0.01</span></span>
<span id="c072fb7d-3"><a href="#c072fb7d-3" aria-hidden="true" tabindex="-1"></a>    SIMULATIONS <span class="op">=</span> <span class="dv">10000</span></span>
<span id="c072fb7d-4"><a href="#c072fb7d-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="c072fb7d-5"><a href="#c072fb7d-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> probabilistic_round(x):</span>
<span id="c072fb7d-6"><a href="#c072fb7d-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">int</span>(math.floor(x <span class="op">+</span> random.random()))</span>
<span id="c072fb7d-7"><a href="#c072fb7d-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="c072fb7d-8"><a href="#c072fb7d-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> simulate_once(n_swabs):</span>
<span id="c072fb7d-9"><a href="#c072fb7d-9" aria-hidden="true" tabindex="-1"></a>        n_sick <span class="op">=</span> probabilistic_round(FRAC_SICK <span class="op">*</span> n_swabs)</span>
<span id="c072fb7d-10"><a href="#c072fb7d-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> n_sick:</span>
<span id="c072fb7d-11"><a href="#c072fb7d-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">0</span></span>
<span id="c072fb7d-12"><a href="#c072fb7d-12" aria-hidden="true" tabindex="-1"></a>        ra <span class="op">=</span> <span class="dv">0</span></span>
<span id="c072fb7d-13"><a href="#c072fb7d-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_sick):</span>
<span id="c072fb7d-14"><a href="#c072fb7d-14" aria-hidden="true" tabindex="-1"></a>            ra <span class="op">=</span> random.choice(positive_ras)</span>
<span id="c072fb7d-15"><a href="#c072fb7d-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ra <span class="op">/</span> n_swabs</span>
<span id="c072fb7d-16"><a href="#c072fb7d-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="c072fb7d-17"><a href="#c072fb7d-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> simulate_many(n_simulations, n_swabs):</span>
<span id="c072fb7d-18"><a href="#c072fb7d-18" aria-hidden="true" tabindex="-1"></a>        RAs <span class="op">=</span> []</span>
<span id="c072fb7d-19"><a href="#c072fb7d-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_simulations):</span>
<span id="c072fb7d-20"><a href="#c072fb7d-20" aria-hidden="true" tabindex="-1"></a>            RAs.append(simulate_once(n_swabs))</span>
<span id="c072fb7d-21"><a href="#c072fb7d-21" aria-hidden="true" tabindex="-1"></a>        RAs.sort()</span>
<span id="c072fb7d-22"><a href="#c072fb7d-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="c072fb7d-23"><a href="#c072fb7d-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [</span>
<span id="c072fb7d-24"><a href="#c072fb7d-24" aria-hidden="true" tabindex="-1"></a>            RAs[probabilistic_round(<span class="bu">len</span>(RAs) <span class="op">*</span> percentile <span class="op">/</span> <span class="dv">100</span>)]</span>
<span id="c072fb7d-25"><a href="#c072fb7d-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> percentile <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">100</span>)</span>
<span id="c072fb7d-26"><a href="#c072fb7d-26" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="c072fb7d-27"><a href="#c072fb7d-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="c072fb7d-28"><a href="#c072fb7d-28" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> defaultdict(<span class="bu">list</span>)</span>
<span id="c072fb7d-29"><a href="#c072fb7d-29" aria-hidden="true" tabindex="-1"></a>    n_swab_range <span class="op">=</span> [<span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">400</span>, <span class="dv">800</span>]</span>
<span id="c072fb7d-30"><a href="#c072fb7d-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> n_swabs <span class="kw">in</span> n_swab_range:</span>
<span id="c072fb7d-31"><a href="#c072fb7d-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> percentile, ra <span class="kw">in</span> <span class="bu">enumerate</span>(simulate_many(SIMULATIONS, n_swabs)):</span>
<span id="c072fb7d-32"><a href="#c072fb7d-32" aria-hidden="true" tabindex="-1"></a>            data[percentile].append(ra)</span>
<span id="c072fb7d-33"><a href="#c072fb7d-33" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(data).T</span>
<span id="c072fb7d-34"><a href="#c072fb7d-34" aria-hidden="true" tabindex="-1"></a>    df.columns <span class="op">=</span> n_swab_range</span>
<span id="c072fb7d-35"><a href="#c072fb7d-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="c072fb7d-36"><a href="#c072fb7d-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="c072fb7d-37"><a href="#c072fb7d-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="c072fb7d-38"><a href="#c072fb7d-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="c072fb7d-39"><a href="#c072fb7d-39" aria-hidden="true" tabindex="-1"></a>df_throat <span class="op">=</span> pd.read_csv(<span class="st">"data/lu_throat_ct_mgs.tsv"</span>, sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>, skiprows<span class="op">=</span><span class="dv">1</span>)</span>
<span id="c072fb7d-40"><a href="#c072fb7d-40" aria-hidden="true" tabindex="-1"></a>df_throat.rename(</span>
<span id="c072fb7d-41"><a href="#c072fb7d-41" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>{<span class="st">"SCV-2 Relative Abundance"</span>: <span class="st">"scv2_ra"</span>, <span class="st">"Ct value"</span>: <span class="st">"scv2_ct"</span>}, inplace<span class="op">=</span><span class="va">True</span></span>
<span id="c072fb7d-42"><a href="#c072fb7d-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="c072fb7d-43"><a href="#c072fb7d-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="c072fb7d-44"><a href="#c072fb7d-44" aria-hidden="true" tabindex="-1"></a>df_nasopharyngeal <span class="op">=</span> pd.read_csv(<span class="st">"data/babiker_np_ct_mgs.tsv"</span>, sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>, skiprows<span class="op">=</span><span class="dv">1</span>)</span>
<span id="c072fb7d-45"><a href="#c072fb7d-45" aria-hidden="true" tabindex="-1"></a>df_nasopharyngeal.rename(</span>
<span id="c072fb7d-46"><a href="#c072fb7d-46" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>{</span>
<span id="c072fb7d-47"><a href="#c072fb7d-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"SARS-CoV-2 RT-PCR Ct"</span>: <span class="st">"scv2_ct"</span>,</span>
<span id="c072fb7d-48"><a href="#c072fb7d-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">"SARS-CoV-2 RA"</span>: <span class="st">"scv2_ra"</span>,</span>
<span id="c072fb7d-49"><a href="#c072fb7d-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Inpatient/ED vs. Outpatient"</span>: <span class="st">"patient_status"</span>,</span>
<span id="c072fb7d-50"><a href="#c072fb7d-50" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="c072fb7d-51"><a href="#c072fb7d-51" aria-hidden="true" tabindex="-1"></a>    inplace<span class="op">=</span><span class="va">True</span>,</span>
<span id="c072fb7d-52"><a href="#c072fb7d-52" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="c072fb7d-53"><a href="#c072fb7d-53" aria-hidden="true" tabindex="-1"></a>df_nasopharyngeal[<span class="st">"scv2_ct"</span>] <span class="op">=</span> (</span>
<span id="c072fb7d-54"><a href="#c072fb7d-54" aria-hidden="true" tabindex="-1"></a>    df_throat[<span class="st">"scv2_ct"</span>].replace(<span class="st">","</span>, <span class="st">"."</span>, regex<span class="op">=</span><span class="va">True</span>).astype(<span class="bu">float</span>)</span>
<span id="c072fb7d-55"><a href="#c072fb7d-55" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="c072fb7d-56"><a href="#c072fb7d-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="c072fb7d-57"><a href="#c072fb7d-57" aria-hidden="true" tabindex="-1"></a>df_throat_ras <span class="op">=</span> df_throat[<span class="st">"scv2_ra"</span>].dropna().tolist()</span>
<span id="c072fb7d-58"><a href="#c072fb7d-58" aria-hidden="true" tabindex="-1"></a>df_nasopharyngeal_ras <span class="op">=</span> df_nasopharyngeal[<span class="st">"scv2_ra"</span>].dropna().tolist()</span>
<span id="c072fb7d-59"><a href="#c072fb7d-59" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">5</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="c072fb7d-60"><a href="#c072fb7d-60" aria-hidden="true" tabindex="-1"></a>n_swab_range <span class="op">=</span> [<span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">400</span>, <span class="dv">800</span>]</span>
<span id="c072fb7d-61"><a href="#c072fb7d-61" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, positive_ras <span class="kw">in</span> <span class="bu">enumerate</span>([df_throat_ras, df_nasopharyngeal_ras]):</span>
<span id="c072fb7d-62"><a href="#c072fb7d-62" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> simulate_detection(positive_ras)</span>
<span id="c072fb7d-63"><a href="#c072fb7d-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> n_swabs <span class="kw">in</span> n_swab_range:</span>
<span id="c072fb7d-64"><a href="#c072fb7d-64" aria-hidden="true" tabindex="-1"></a>        axs[i].plot(df.index, df[n_swabs], label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>n_swabs<span class="sc">}</span><span class="ss"> swabs"</span>)</span>
<span id="c072fb7d-65"><a href="#c072fb7d-65" aria-hidden="true" tabindex="-1"></a>    axs[i].set_xlabel(<span class="st">"Percentile"</span>)</span>
<span id="c072fb7d-66"><a href="#c072fb7d-66" aria-hidden="true" tabindex="-1"></a>    axs[i].set_ylabel(<span class="st">"RA"</span>)</span>
<span id="c072fb7d-67"><a href="#c072fb7d-67" aria-hidden="true" tabindex="-1"></a>    axs[i].set_yscale(<span class="st">"log"</span>)</span>
<span id="c072fb7d-68"><a href="#c072fb7d-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># turn on y tick labels for both plots</span></span>
<span id="c072fb7d-69"><a href="#c072fb7d-69" aria-hidden="true" tabindex="-1"></a>    axs[i].yaxis.set_tick_params(labelleft<span class="op">=</span><span class="va">True</span>)</span>
<span id="c072fb7d-70"><a href="#c072fb7d-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="dv">20</span>):</span>
<span id="c072fb7d-71"><a href="#c072fb7d-71" aria-hidden="true" tabindex="-1"></a>        axs[i].axvline(x<span class="op">=</span>x, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="c072fb7d-72"><a href="#c072fb7d-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="c072fb7d-73"><a href="#c072fb7d-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> y <span class="kw">in</span> <span class="bu">range</span>(<span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="dv">10</span>, <span class="op">-</span><span class="dv">1</span>):</span>
<span id="c072fb7d-74"><a href="#c072fb7d-74" aria-hidden="true" tabindex="-1"></a>        log_y <span class="op">=</span> <span class="dv">10</span><span class="op">**</span>y</span>
<span id="c072fb7d-75"><a href="#c072fb7d-75" aria-hidden="true" tabindex="-1"></a>        axs[i].axhline(y<span class="op">=</span>log_y, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="c072fb7d-76"><a href="#c072fb7d-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> i <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="c072fb7d-77"><a href="#c072fb7d-77" aria-hidden="true" tabindex="-1"></a>        axs[i].set_title(<span class="st">"Throat"</span>)</span>
<span id="c072fb7d-78"><a href="#c072fb7d-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="c072fb7d-79"><a href="#c072fb7d-79" aria-hidden="true" tabindex="-1"></a>        axs[i].set_title(<span class="st">"Nasopharyngeal"</span>)</span>
<span id="c072fb7d-80"><a href="#c072fb7d-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="c072fb7d-81"><a href="#c072fb7d-81" aria-hidden="true" tabindex="-1"></a>    axs[i].spines[<span class="st">"right"</span>].set_visible(<span class="va">False</span>)</span>
<span id="c072fb7d-82"><a href="#c072fb7d-82" aria-hidden="true" tabindex="-1"></a>    axs[i].spines[<span class="st">"top"</span>].set_visible(<span class="va">False</span>)</span>
<span id="c072fb7d-83"><a href="#c072fb7d-83" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"both"</span>, bottom<span class="op">=</span><span class="va">False</span>, top<span class="op">=</span><span class="va">False</span>, labelbottom<span class="op">=</span><span class="va">True</span>)</span>
<span id="c072fb7d-84"><a href="#c072fb7d-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> i <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="c072fb7d-85"><a href="#c072fb7d-85" aria-hidden="true" tabindex="-1"></a>        axs[i].legend()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/cell-8-output-1.png" width="749" height="449" class="figure-img"></p>
<figcaption><strong>Figure 5: Simulated detection capability of pooled swab sampling.</strong> Left Figure: Throat Swabs. Data from Lu et al.&nbsp;2021. Right Figure: Nasopharyngeal Swabs. Data from Babiker et al.&nbsp;2020.</figcaption>
</figure>
</div>
</div>
</div>
<section id="next-steps" class="level2">
<h2 class="anchored" data-anchor-id="next-steps">Next steps</h2>
<ul>
<li>Pull in additional qPCR studies.</li>
<li>Read into research on comparing CT values across studies and search for standard curves in existing papers.</li>
<li>Lay out what you would do if you had standard curves available.</li>
</ul>
<p>Create a figure for the remaining viruses not covered in Figure 3.</p>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>The mid-turbinate region is the area between the nasal opening (Nares) and the nasopharynx.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>A 1-log difference in genome copy number is equivalent to a 3.3 CT difference. This is because each cycle in a qPCR machine approxiately equates to doubling of the genome copy number.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>See <a href="https://elifesciences.org/articles/46923">McClaren et al.&nbsp;2019</a> for further discussion.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>